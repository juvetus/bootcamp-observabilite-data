version: "3.8"

services:
  dd-agent:
    image: datadog/agent:latest
    container_name: dd-agent
    environment:
      - DD_API_KEY=${DD_API_KEY}
      - DD_SITE=${DD_SITE:-datadoghq.eu}
      - DD_DOGSTATSD_NON_LOCAL_TRAFFIC=true
      - DD_APM_ENABLED=true
      - DD_APM_NON_LOCAL_TRAFFIC=true
      - DD_LOGS_ENABLED=true
      - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
    ports:
      - "8126:8126"
      - "8125:8125/udp"
    networks:
      - fabric-network

  fabric-sim:
    build: .
    command: >
      sh -c "python pipelines/ingest.py &&
             python pipelines/transform.py &&
             python pipelines/validate.py"
    container_name: fabric-sim
    environment:
      - DD_API_KEY=${DD_API_KEY}
      - DD_SITE=${DD_SITE:-datadoghq.eu}
      - DD_AGENT_HOST=dd-agent
      - DD_DOGSTATSD_PORT=8125
      - DD_TRACE_AGENT_PORT=8126
      - DD_SERVICE=${PIPELINE_NAME:-docker-fabric-pipeline}
      - DD_ENV=${ENV:-dev}
      - DD_VERSION=1.0.0
      - PIPELINE_NAME=${PIPELINE_NAME:-docker-fabric-pipeline}
      - ENV=${ENV:-dev}
      - RAW_PATH=/app/data/raw
      - BRONZE_PATH=/app/data/bronze
      - SILVER_PATH=/app/data/silver
      - GOLD_PATH=/app/data/gold
      - TEMP_THRESHOLD=95
    volumes:
      - ./data:/app/data
      - ./pipelines:/app/pipelines
      - ./monitoring:/app/monitoring
    depends_on:
      - dd-agent
    networks:
      - fabric-network

networks:
  fabric-network:
    driver: bridge